## üéôÔ∏è Custom Discord Voice Client Implementation

### Core Voice System
- **Created DiscordVoiceClient.cs** - Full manual WebSocket + UDP implementation
  * Bypasses Discord.NET AudioClient to avoid session conflicts (error 4006)
  * Complete Discord Voice protocol: HELLO ‚Üí IDENTIFY ‚Üí READY ‚Üí IP Discovery ‚Üí SELECT_PROTOCOL
  * Heartbeat loop for connection stability
  * RTP packet construction with Opus encoding
  * XSalsa20_Poly1305 encryption for voice data

- **Added VoiceService2.cs** - Proper voice state management
  * Uses reflection to call ConnectAudioAsync with 'external=true' flag
  * Prevents Discord.NET from creating competing AudioClient
  * Handles VOICE_STATE_UPDATE and VOICE_SERVER_UPDATE events
  * Supports multiple plays with configurable gap between repetitions
  * FFmpeg integration for WAV to PCM conversion (48kHz stereo)

### Critical Voice Fixes

#### Hex Token Conversion (Main Issue)
- **Problem**: Discord Gateway returns token as 16-char hex string
- **Solution**: Convert hex ‚Üí base64 before sending to Voice WebSocket
- Discord Voice protocol expects base64 token, not hex
- Added automatic detection and conversion in ConnectAsync

#### Session Conflicts
- **Problem**: Both Discord.NET AudioClient and custom client trying to connect
- **Solution**: Use 'external=true' flag via reflection to disable AudioClient
- Prevents error 4006 'Session is no longer valid'

#### Dual IDENTIFY Prevention
- Removed duplicate IDENTIFY sending that caused authentication failures
- Single IDENTIFY after HELLO + initial heartbeat

## ‚ú® New Features - Repeat Settings

### Configurable Sound Playback
- **Added repeat_plays**: Number of times to play sound (1-10, default: 3)
- **Added repeat_gap_ms**: Gap between repeats in milliseconds (0-5000ms, default: 1000ms)
- New UI section with compact inline layout (plays, gap, save button)
- Settings persisted to respawn.settings.json
- Instant save via PATCH endpoint

### Testing Infrastructure
- **Custom Sounds UI section** with test buttons
- Individual buttons for 10m and 2h sounds
- 'Once' and 'Loop' modes for testing
- File upload for custom sound replacement
- Real-time feedback on test status

## üîß API Enhancements

### Worker Endpoints
- **Added PATCH /settings** - Partial update for settings
- **Updated GET /settings** - Returns repeat_plays and repeat_gap_ms
- **Updated POST /settings** - Reads repeat settings from request
- **Fixed GET /channels/voice** - Accurate userCount via VoiceState
- **Added POST /respawn/test-sound** - Sound testing endpoint
  * Supports sound (10m/2h) and use_settings parameters
  * Fire-and-forget task execution for non-blocking tests
  * Channel validation and error handling

### API Proxy
- **Added PATCH /settings** proxy to Worker
- **Added POST /sounds/upload** for custom sound files
- **Added POST /respawn/test-sound** proxy

## üêõ Bug Fixes

### Audio Playback
- **Fixed audio cutoff** - Sends partial buffer at EOF to prevent cutting last milliseconds
- **Fixed repeat playback** - Correctly applies repeat_plays and repeat_gap_ms
- **Fixed loop parameter** - Properly used in test-sound endpoint
- **Fixed EOF handling** - PlayWavAsync now handles end-of-stream correctly

### Settings Persistence
- **Fixed SettingsStore.LoadAsync** - Reads repeat_plays and repeat_gap_ms from JSON
- **Fixed SettingsStore.SaveAsync** - Writes repeat settings to JSON
- **Fixed PersistedSettings.Default()** - Includes default repeat values
- **Fixed settings load** - Correctly loads on application start
- **Fixed POST /settings** - Preserves repeat values when updating other settings

### Voice Channel Display
- **Fixed userCount calculation** - Changed from c.Users.Count to VoiceState counting
- Shows accurate number of users in channel selection modal
- All channels now display correct active user counts

### UI/UX Fixes
- **Fixed viewer permissions** - All interactive elements disabled for viewer role:
  * Input fields (baseTime, leadSeconds, repeat-plays, repeat-gap-ms)
  * Sound playback buttons (Once, Loop)
  * Upload buttons and file inputs
  * All save buttons properly restricted
- **Improved disabled input styling** - Better readability
- **Fixed file input styling** - Darker background, better contrast
- **Fixed step validation** - repeat_gap_ms accepts values in 50ms increments

## üîç Logging & Debugging
- Comprehensive debug logging throughout voice connection flow
- Token analysis: hex detection, base64 conversion logging
- WebSocket state tracking with emoji indicators (üîå‚úÖ‚ö†Ô∏è)
- Raw payload inspection capabilities
- Call ID tracking for concurrent execution debugging
- Detailed voice event logging (VOICE_STATE_UPDATE, VOICE_SERVER_UPDATE)

## üìù Technical Implementation

### Protocol Details
- Discord Voice API v4 WebSocket connection
- Opus encoding: 48kHz, 2 channels, 960 frame size, 128 kbps bitrate
- RTP: 12-byte header + encrypted Opus payload
- Encryption: XSalsa20_Poly1305 with 24-byte nonce
- UDP for voice data transmission

### Dependencies
- Concentus.Structs: Opus audio encoding
- libsodium-net: XSalsa20_Poly1305 encryption
- System.Net.WebSockets: Voice gateway connection
- System.Net.Sockets: UDP for RTP packets

### Error Handling
- WebSocket close detection and logging
- Heartbeat failure recovery
- UDP connection timeout handling
- FFmpeg process error logging
- Graceful cleanup on connection failure

## üì¶ Configuration Changes

### New JSON Fields in respawn.settings.json
\`\`\`json
{
  \"repeat_plays\": 3,
  \"repeat_gap_ms\": 1000
}
\`\`\`

## üé® UI Improvements
- Compact repeat settings layout with inline controls
- Custom sounds section with upload capability
- Test buttons for immediate feedback
- Better visual feedback for disabled state
- Improved file input appearance
- All viewer restrictions properly enforced

## üîÑ Code Refactoring
- Consolidated settings save/load logic
- Improved PATCH endpoint for partial updates
- Better separation between POST (full) and PATCH (partial)
- Cleaned up VoiceService2 audio playback logic
- Removed old VoiceService.cs in favor of VoiceService2

## üìÇ Files Changed
### New Files
- src/Ogur.Sentinel.Worker/Services/DiscordVoiceClient.cs
- src/Ogur.Sentinel.Worker/Services/VoiceService2.cs
- src/Ogur.Sentinel.Worker/Discord/DiscordReadyService.cs
- src/Ogur.Sentinel.Api/Http/ProxyEndpoints.cs
- NuGet.Config

### Modified Files
- src/Ogur.Sentinel.Abstractions/Respawn/PersistedSettings.cs
- src/Ogur.Sentinel.Core/Respawn/RespawnState.cs
- src/Ogur.Sentinel.Worker/Services/SettingsStore.cs
- src/Ogur.Sentinel.Worker/Http/InternalEndpoints.cs
- src/Ogur.Sentinel.Worker/Discord/DiscordBotHostedService.cs
- src/Ogur.Sentinel.Worker/Discord/Modules/RespawnModule.cs
- src/Ogur.Sentinel.Worker/Services/RespawnSchedulerService.cs
- src/Ogur.Sentinel.Worker/Program.cs
- src/Ogur.Sentinel.Api/Pages/Respawn.cshtml
- src/Ogur.Sentinel.Api/wwwroot/css/site.css
- src/Ogur.Sentinel.Worker/appsettings/respawn.settings.json

### Deleted Files
- src/Ogur.Sentinel.Worker/Services/VoiceService.cs

## ‚úÖ Testing
- Tested on local development environment
- Fixed multiple token authentication iterations
- Verified external=true flag prevents AudioClient conflicts
- Confirmed hex‚Üíbase64 conversion resolves 4003 errors
- Tested repeat playback with various settings
- Verified viewer permission restrictions
- Confirmed accurate user counts in voice channels

---
**Full Changelog**: v1.1.1...v1.1.2"
